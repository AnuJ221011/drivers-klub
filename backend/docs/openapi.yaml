openapi: 3.0.0
info:
  title: Driver's Klub Backend API
  description: |
    # Driver's Klub Backend API (Master Canonical Reference)

    **Version 2.0.0 - Production**

    This specification represents the **Single Source of Truth** for the Driver's Klub platform. It combines strict schema definitions, business logic documentation, and comprehensive endpoint coverage.

    ## üîç System Overview & Business Logic

    ### 1. Trip Intelligence
    *   **Booking Window**: A strict "T-1" rule applies. Trips must be booked at least **1 day in advance**.
    *   **Operational Hours**: Trips cannot start between 12:00 AM and 04:00 AM (`PREBOOK_MIN_HOUR = 4`).
    *   **Allowed Origins**: Pickups are restricted to `DELHI`, `NOIDA`, `GURGAON`, `FARIDABAD`, `GHAZIABAD`.
    *   **Vehicle Policy**: Currently exclusive to `TATA_TIGOR_EV` to meet green fleet targets.

    ### 2. Pricing Engine
    *   **Base Rate**: ‚Çπ25.00 per km.
    *   **Minimum Fare**: Minimum billable distance is 5 km.
    *   **Multipliers**:
        *   `AIRPORT`: 1.0x (Standard)
        *   `RENTAL`: 1.1x (Premium Hold)
        *   `INTER_CITY`: 1.2x (Outstation Allowance)

    ### 3. Provider Orchestration
    *   The system acts as a meta-layer over external providers (**MojoBoxx**, **MMT**).
    *   **Sync**: Trip status is synced every 60s via background jobs, but can be force-synced via `/providers/{id}/sync`.
    *   **Dispatch**: If internal fleet is unavailable, the `DispatchEngine` routes bookings to external providers automatically.

    ### 4. Payment System (NEW)
    *   **Rental Model**: Drivers pay upfront rental + deposit. Valid for set days.
    *   **Payout Model**: Revenue share (70/30 split). Daily collections via Virtual QR.
    *   **Reconciliation**: Automatic reconciling of UPI payments; manual for cash.
    *   **Gateway**: Integrated with **Easebuzz** for Collections & Payouts.

  version: 2.0.0
  contact:
    name: Driver's Klub Engineering

servers:
  - url: https://driversklub-backend.onrender.com/
    description: Production API
  - url: http://localhost:5000
    description: Development API

components:
  securitySchemes:
    bearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT

  schemas:
    # --- COMMON ---
    ApiResponse:
      type: object
      required:
        - message
      properties:
        success:
          type: boolean
          example: true
        message:
          type: string
          example: "Operation completed successfully"
        data:
          type: object

    # --- ENUMS ---
    UserRole:
      type: string
      enum: [SUPER_ADMIN, OPERATIONS, MANAGER, DRIVER]
    TripType:
      type: string
      enum: [AIRPORT, RENTAL, INTER_CITY]
    VehicleStatus:
      type: string
      enum: [ACTIVE, INACTIVE, MAINTENANCE]
    PaymentModel:
      type: string
      enum: [RENTAL, PAYOUT]
    TransactionType:
      type: string
      enum:
        [
          DEPOSIT,
          RENTAL,
          TRIP_PAYMENT,
          INCENTIVE,
          PENALTY,
          DAILY_COLLECTION,
          PAYOUT,
        ]
    TransactionStatus:
      type: string
      enum: [PENDING, SUCCESS, FAILED, REFUNDED]

    # --- CORE ENTITIES ---
    User:
      type: object
      properties:
        id: { type: string, format: uuid }
        name: { type: string }
        phone: { type: string }
        role: { $ref: "#/components/schemas/UserRole" }
        isActive: { type: boolean }

    Driver:
      type: object
      properties:
        id: { type: string, format: uuid }
        firstName: { type: string }
        lastName: { type: string }
        mobile: { type: string }
        licenseNumber: { type: string }
        status: { type: string }
        isAvailable: { type: boolean }
        paymentModel: { $ref: "#/components/schemas/PaymentModel" }
        depositBalance: { type: number }

    Fleet:
      type: object
      properties:
        id: { type: string, format: uuid }
        name: { type: string }
        city: { type: string }
        mobile: { type: string }

    Vehicle:
      type: object
      properties:
        id: { type: string, format: uuid }
        vehicleNumber: { type: string }
        model: { type: string }
        status: { $ref: "#/components/schemas/VehicleStatus" }
        virtualQRId: { type: string, format: uuid }

    Trip:
      type: object
      properties:
        id: { type: string, format: uuid }
        tripType: { $ref: "#/components/schemas/TripType" }
        originCity: { type: string }
        destinationCity: { type: string }
        tripDate: { type: string, format: date-time }
        status: { type: string }
        price: { type: number }

    # --- PAYMENT ENTITIES ---
    Transaction:
      type: object
      properties:
        id: { type: string, format: uuid }
        type: { $ref: "#/components/schemas/TransactionType" }
        amount: { type: number }
        status: { $ref: "#/components/schemas/TransactionStatus" }
        createdAt: { type: string, format: date-time }

    RentalPlan:
      type: object
      properties:
        id: { type: string, format: uuid }
        name: { type: string }
        rentalAmount: { type: number }
        depositAmount: { type: number }
        validityDays: { type: number }

    DailyCollection:
      type: object
      properties:
        id: { type: string, format: uuid }
        date: { type: string, format: date }
        totalCollection: { type: number }
        qrCollectionAmount: { type: number }
        cashCollectionAmount: { type: number }
        netPayout: { type: number }
        isReconciled: { type: boolean }

    PaymentOrder:
      type: object
      properties:
        id: { type: string, format: uuid }
        virtualAccountId: { type: string }
        customerName: { type: string }
        totalAmount: { type: number }
        collectedAmount: { type: number }
        remainingAmount: { type: number }
        status: { type: string, enum: [PENDING, PARTIAL, COMPLETED] }

security:
  - bearerAuth: []

paths:
  # ================= AUTH =================
  /auth/send-otp:
    post:
      tags: [Auth]
      summary: Send Login OTP
      requestBody:
        content:
          application/json:
            schema:
              type: object
              required: [phone]
              properties:
                phone: { type: string }
      responses:
        200:
          description: OTP Sent

  /auth/verify-otp:
    post:
      tags: [Auth]
      summary: Verify OTP & Login
      requestBody:
        content:
          application/json:
            schema:
              type: object
              required: [phone, otp]
              properties:
                phone: { type: string }
                otp: { type: string }
      responses:
        200:
          description: Tokens Issued

  # ================= PAYMENT (DRIVER) =================
  /payment/balance:
    get:
      tags: [Payment]
      summary: Get Driver Balance & Model
      responses:
        200:
          description: Balance Details
          content:
            application/json:
              schema:
                type: object
                properties:
                  depositBalance: { type: number }
                  paymentModel: { $ref: "#/components/schemas/PaymentModel" }

  /payment/transactions:
    get:
      tags: [Payment]
      summary: List Transactions
      parameters:
        - name: page
          in: query
          schema: { type: integer }
        - name: type
          in: query
          schema: { $ref: "#/components/schemas/TransactionType" }
      responses:
        200:
          description: Transaction History

  /payment/deposit:
    post:
      tags: [Payment]
      summary: Initiate Deposit Payment
      requestBody:
        content:
          application/json:
            schema:
              type: object
              required: [amount]
              properties:
                amount: { type: number }
      responses:
        200:
          description: Payment Link Generated

  /payment/rental:
    post:
      tags: [Payment]
      summary: Initiate Rental Payment
      requestBody:
        content:
          application/json:
            schema:
              type: object
              required: [rentalPlanId]
              properties:
                rentalPlanId: { type: string, format: uuid }
      responses:
        200:
          description: Payment Link Generated

  # ================= PAYMENT (ADMIN) =================
  /payment/admin/rental-plans:
    post:
      tags: [Payment Admin]
      summary: Create Rental Plan
      requestBody:
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/RentalPlan"
      responses:
        201:
          description: Plan Created

  /payment/admin/payouts/process:
    post:
      tags: [Payment Admin]
      summary: Process Batch Payouts
      description: "Trigger payouts for selected collections."
      responses:
        200:
          description: Payouts Initiated

  /payment/orders:
    post:
      tags: [Payment Admin]
      summary: Create InstaCollect Order
      requestBody:
        content:
          application/json:
            schema:
              type: object
              required: [customerName, customerPhone, amount]
              properties:
                customerName: { type: string }
                customerPhone: { type: string }
                amount: { type: number }
                description: { type: string }
      responses:
        201:
          description: Order Created
    get:
      tags: [Payment Admin]
      summary: List Orders
      responses:
        200: { description: List of Orders }

  /payment/orders/{id}:
    get:
      tags: [Payment Admin]
      summary: Get Order Details
      parameters:
        - name: id
          in: path
          required: true
          schema: { type: string }
      responses:
        200: { description: Order Details }

  # ================= WEBHOOKS =================
  /webhooks/easebuzz:
    post:
      tags: [Webhooks]
      summary: Easebuzz Payment Webhook
      description: "Receives payment status updates from Easebuzz."
      security: []
      requestBody:
        content:
          application/x-www-form-urlencoded:
            schema:
              type: object
              properties:
                txnid: { type: string }
                status: { type: string }
                hash: { type: string }
      responses:
        200:
          description: Processed

  # ================= CORE ENTITIES (Abbreviated) =================
  /users:
    get:
      tags: [Users]
      summary: List Users
      responses:
        200: { description: OK }

  /drivers:
    get:
      tags: [Drivers]
      summary: List Drivers
      responses:
        200: { description: OK }
    post:
      tags: [Drivers]
      summary: Create Driver
      responses:
        201: { description: Created }

  /fleets:
    get:
      tags: [Fleets]
      summary: List Fleets
      responses:
        200: { description: OK }

  /vehicles:
    get:
      tags: [Vehicles]
      summary: List Vehicles
      responses:
        200: { description: OK }

  /trips:
    post:
      tags: [Trips]
      summary: Create/Prebook Trip
      responses:
        201: { description: Trip Created }

  /update-location:
    post:
      tags: [Trips]
      summary: Driver Location Update
      requestBody:
        content:
          application/json:
            schema:
              type: object
              required: [lat, lng]
              properties:
                lat: { type: number }
                lng: { type: number }
      responses:
        200: { description: Location Updated }

  # ================= MMT PARTNER ENDPOINTS =================
  /partner/mmt/partnersearchendpoint:
    post:
      tags: [MMT]
      summary: MMT Fare Search
      responses:
        200: { description: OK }

  /partner/mmt/partnerblockendpoint:
    post:
      tags: [MMT]
      summary: MMT Block Ride
      responses:
        200: { description: OK }

  /partner/mmt/partnerpaidendpoint:
    post:
      tags: [MMT]
      summary: MMT Confirm Paid
      responses:
        200: { description: OK }

  /partner/mmt/partnercancelendpoint:
    post:
      tags: [MMT]
      summary: MMT Cancel Ride
      responses:
        200: { description: OK }

  /partner/mmt/partnerrescheduleblockendpoint:
    post:
      tags: [MMT]
      summary: MMT Reschedule Block (Check)
      requestBody:
        content:
          application/json:
            schema:
              type: object
              required: [order_reference_number, start_time]
              properties:
                order_reference_number: { type: string }
                start_time: { type: string, format: date-time }
      responses:
        200:
          description: Reschedule Allowed
          content:
            application/json:
              schema:
                type: object
                properties:
                  response:
                    type: object
                    properties:
                      success: { type: boolean }

  /partner/mmt/partnerrescheduleconfirmendpoint:
    post:
      tags: [MMT]
      summary: MMT Reschedule Confirm
      requestBody:
        content:
          application/json:
            schema:
              type: object
              required: [order_reference_number]
              properties:
                order_reference_number: { type: string }
      responses:
        200:
          description: Reschedule confirmed
          content:
            application/json:
              schema:
                type: object
                properties:
                  response:
                    type: object
                    properties:
                      success: { type: boolean }

  /partner/mmt/booking/details:
    get:
      tags: [MMT]
      summary: MMT Booking Details
      parameters:
        - name: partner_reference_number
          in: query
          schema: { type: string }
        - name: order_reference_number
          in: query
          schema: { type: string }
      responses:
        200: { description: OK }

  # ================= RAPIDO PARTNER ENDPOINTS =================
  /rapido/webhook/order-status:
    post:
      summary: Rapido Order Status Callback
      description: Webhook for Rapido order status updates
      tags:
        - Rapido
      requestBody:
        content:
          application/json:
            schema:
              type: object
              properties:
                orderId:
                  type: string
                status:
                  type: string
                captainId:
                  type: string
                timestamp:
                  type: string
      responses:
        "200":
          description: Status updated successfully

  /rapido/webhook/captain-status:
    post:
      summary: Rapido Captain Status Callback
      description: Webhook for Captain availability updates
      tags:
        - Rapido
      requestBody:
        content:
          application/json:
            schema:
              type: object
              properties:
                captainId:
                  type: string
                status:
                  type: string
                location:
                  type: object
      responses:
        "200":
          description: Status updated successfully
