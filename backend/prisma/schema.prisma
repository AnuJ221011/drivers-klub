generator client {
  provider   = "prisma-client-js"
  engineType = "library"
}

datasource db {
  provider = "postgresql"
}

// User Model for application users
enum UserRole {
  SUPER_ADMIN
  OPERATIONS
  MANAGER
  DRIVER
}

model User {
  id        String   @id @default(uuid())
  name      String
  phone     String   @unique
  role      UserRole
  isActive  Boolean  @default(true)

  driver    Driver?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  refreshTokens RefreshToken[]

  @@index([role])
}

model RefreshToken {
  id        String   @id @default(uuid())
  token     String   @unique
  userId    String
  expiresAt DateTime
  createdAt DateTime @default(now())

  // relation to User
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

// Otp Model for phone verification
model Otp {
  id          String   @id @default(uuid())
  phone       String
  otp         String
  expiresAt   DateTime
  attempts    Int      @default(0)
  verified    Boolean  @default(false)

  createdAt  DateTime @default(now())

  @@index([phone])
}


// Fleet Model for fleet operators
enum FleetType {
  INDIVIDUAL
  COMPANY
}

enum FleetStatus {
  ACTIVE
  INACTIVE
}

enum FleetManagerStatus {
  ACTIVE
  INACTIVE
}


model Fleet {
  id           String      @id @default(uuid())

  name         String
  mobile       String      @unique
  email        String?
  city         String
  dob          DateTime?

  fleetType    FleetType
  gstNumber    String?
  panNumber    String
  modeId       String      // CAB, BIKE (future)

  status       FleetStatus @default(ACTIVE)

  // relations
  // fleetManagers relation
  fleetManagers FleetManager[]
  // vehicles relation
  vehicles      Vehicle[]
  // drivers relation
  drivers       Driver[]
  // assignments relation
  assignments   Assignment[]
  // trips relation
  trips         Trip[]


  createdAt    DateTime    @default(now())
  updatedAt    DateTime    @updatedAt

  @@index([mobile])
  @@index([city])
}

// FleetManager Model for fleet managers
model FleetManager {
  id             String             @id @default(uuid())

  name           String
  mobile         String
  city           String
  profilePicture String?

  status         FleetManagerStatus @default(ACTIVE)
  remarks        String?
  
  fleetId        String
  fleet          Fleet              @relation(fields: [fleetId], references: [id], onDelete: Cascade)

  createdAt      DateTime           @default(now())
  updatedAt      DateTime           @updatedAt

  @@index([fleetId])
  @@index([mobile])
}

// Vehicle Model for fleet vehicles
enum VehicleOwnership {
  OWNED
  LEASED
}

enum FuelType {
  PETROL
  DIESEL
  CNG
  ELECTRIC
}

enum VehicleStatus {
  ACTIVE
  INACTIVE
}

model Vehicle {
  id                String          @id @default(uuid())

  fleetId           String
  fleet             Fleet           @relation(fields: [fleetId], references: [id], onDelete: Cascade)
  
  // Assignments relation
  assignments       Assignment[]
  // Trips relation
  trips             Trip[]



  vehicleNumber     String
  vehicleName       String
  vehicleModel      String
  vehicleColor      String?

  ownership         VehicleOwnership
  fuelType          FuelType

  rcFrontImage      String?
  rcBackImage       String?

  permitImage       String?
  permitExpiry      DateTime?

  fitnessImage      String?
  fitnessExpiry     DateTime?

  insuranceImage    String?
  insuranceExpiry   DateTime?

  status            VehicleStatus   @default(ACTIVE)

  createdAt         DateTime        @default(now())
  updatedAt         DateTime        @updatedAt

  @@unique([vehicleNumber])
  @@index([fleetId])
}

// Driver Model for fleet drivers
enum DriverStatus {
  ACTIVE
  INACTIVE
}

enum KycStatus {
  PENDING
  APPROVED
  REJECTED
}

model Driver {
  id                   String      @id @default(uuid())

  // Relations
  userId               String      @unique
  user                 User        @relation(fields: [userId], references: [id], onDelete: Cascade)

  fleetId              String
  fleet                Fleet       @relation(fields: [fleetId], references: [id], onDelete: Cascade)
  
  // Assignments realtion
  assignments          Assignment[]
  // Trips relation
  trips                Trip[]
  // Trip assignments relation
  tripAssignments      TripAssignment[]
  isAvailable Boolean  @default(true)



  // Basic info
  firstName            String
  lastName             String
  mobile               String
  profilePic           String?

  // KYC documents
  licenseFront         String?
  licenseBack          String?

  aadharFront          String?
  aadharBack           String?

  panCardImage         String?
  livePhoto            String?

  bankIdProof          String?

  // Status
  kycStatus            KycStatus   @default(PENDING)
  status               DriverStatus @default(ACTIVE)

  createdAt            DateTime    @default(now())
  updatedAt            DateTime    @updatedAt

  @@index([fleetId])
  @@index([mobile])
}

// Assignment Model for Driver-Vehicle assignment to Fleet
enum AssignmentStatus {
  ACTIVE
  ENDED
  ASSIGNED
  UNASSIGNED
  COMPLETED
  CANCELLED
}

model Assignment {
  id          String            @id @default(uuid())

  // Relations

  fleetId     String
  fleet       Fleet             @relation(fields: [fleetId], references: [id], onDelete: Cascade)

  driverId    String
  driver      Driver            @relation(fields: [driverId], references: [id], onDelete: Cascade)

  vehicleId   String
  vehicle     Vehicle           @relation(fields: [vehicleId], references: [id], onDelete: Cascade)
  
  // Trips relation
  trips       Trip[]


  status      AssignmentStatus  @default(ACTIVE)

  startTime   DateTime          @default(now())
  endTime     DateTime?

  createdAt   DateTime          @default(now())
  updatedAt   DateTime          @updatedAt

  @@index([fleetId])
  @@index([driverId])
  @@index([vehicleId])
}

// Trip Model for tracking trips
enum TripStatus {
  CREATED
  STARTED
  COMPLETED
  CANCELLED
}

model Trip {
  id          String     @id @default(uuid())

  fleetId     String
  fleet       Fleet      @relation(fields: [fleetId], references: [id])

  driverId    String
  driver      Driver     @relation(fields: [driverId], references: [id])

  vehicleId   String
  vehicle     Vehicle    @relation(fields: [vehicleId], references: [id])

  assignmentId String
  assignment   Assignment @relation(fields: [assignmentId], references: [id])

  pickup      String
  drop        String?

  fare        Float?
  status      TripStatus @default(CREATED)

  startedAt   DateTime?
  completedAt DateTime?

  createdAt   DateTime   @default(now())
}

// RideProviderMapping Model for external ride providers
enum ProviderType {
  INTERNAL
  MOJOBOXX
  MMT
}

enum Provider {
  MOJOBOXX
  MMT
}

enum ProviderBookingStatus {
  PENDING
  CONFIRMED
  FAILED
  CANCELLED
}

enum ProviderRideStatus {
  BOOKED
  DRIVER_ASSIGNED
  STARTED
  COMPLETED
  CANCELLED
  FAILED
}

model RideProviderMapping {
  id                String       @id @default(uuid())
  rideId            String       @unique
  providerType      ProviderType
  externalBookingId String
  providerStatus    String
  rawPayload        Json

  ride Ride @relation(fields: [rideId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// Ride Model for external ride details
// Trip Types
enum TripType {
  AIRPORT
  RENTAL
  INTER_CITY
}

// Ride Model for external ride details (The "Trip" concept for Intelligence)
model Ride {
  id              String   @id @default(uuid())
  tripType        TripType
  originCity      String
  destinationCity String   @default("Unknown")
  pickupTime      DateTime @map("tripDate")
  
  
  distanceKm      Float
  billableKm      Int
  ratePerKm       Int
  price           Float    @map("totalFare") 
  

  vehicleSku      String

  status          String   @default("CREATED")
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt @default(now())
  
  // Provider Fulfillment Fields
  provider             Provider? 
  providerBookingId    String?
  providerStatus       ProviderBookingStatus?
  providerMeta         Json?
  
  // New: Provider Ride Status for Sync
  providerRideStatus   ProviderRideStatus?

  tripAssignments  TripAssignment[]

  providerMapping RideProviderMapping?
}


// TripAssignment Model for assigning trips to drivers
model TripAssignment {
  id          String   @id @default(uuid())

  tripId      String
  driverId    String

  status      AssignmentStatus @default(ASSIGNED)
  
  // Provider Attempt Tracking
  bookingAttempted     Boolean  @default(false)
  bookingFailedReason  String?

  assignedAt  DateTime @default(now())
  unassignedAt DateTime?

  trip        Ride     @relation(fields: [tripId], references: [id])
  driver      Driver   @relation(fields: [driverId], references: [id])

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}
