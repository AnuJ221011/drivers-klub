generator client {
  provider   = "prisma-client-js"
  engineType = "library"
}

datasource db {
  provider = "postgresql"
}

// User Model for application users
enum UserRole {
  SUPER_ADMIN
  OPERATIONS
  MANAGER
  DRIVER
}

model User {
  id        String   @id @default(uuid())
  name      String
  phone     String   @unique
  role      UserRole
  isActive  Boolean  @default(true)

  driver    Driver?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  refreshTokens RefreshToken[]

  @@index([role])
}

model RefreshToken {
  id        String   @id @default(uuid())
  token     String   @unique
  userId    String
  expiresAt DateTime
  createdAt DateTime @default(now())

  // relation to User
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

// Otp Model for phone verification
model Otp {
  id          String   @id @default(uuid())
  phone       String
  otp         String
  expiresAt   DateTime
  attempts    Int      @default(0)
  verified    Boolean  @default(false)

  createdAt  DateTime @default(now())

  @@index([phone])
}


// Fleet Model for fleet operators
enum FleetType {
  INDIVIDUAL
  COMPANY
}

enum FleetStatus {
  ACTIVE
  INACTIVE
}

enum FleetManagerStatus {
  ACTIVE
  INACTIVE
}


model Fleet {
  id           String      @id @default(uuid())

  name         String
  mobile       String      @unique
  email        String?
  city         String
  dob          DateTime?

  fleetType    FleetType
  gstNumber    String?
  panNumber    String
  modeId       String      // CAB, BIKE (future)

  status       FleetStatus @default(ACTIVE)

  // relations
  // fleetManagers relation
  fleetManagers FleetManager[]
  // vehicles relation
  vehicles      Vehicle[]
  // drivers relation
  drivers       Driver[]
  // assignments relation
  assignments   Assignment[]
  // trips relation
  // trips relation removed


  createdAt    DateTime    @default(now())
  updatedAt    DateTime    @updatedAt

  @@index([mobile])
  @@index([city])
}

// FleetManager Model for fleet managers
model FleetManager {
  id             String             @id @default(uuid())

  name           String
  mobile         String
  city           String
  profilePicture String?

  status         FleetManagerStatus @default(ACTIVE)
  remarks        String?
  
  fleetId        String
  fleet          Fleet              @relation(fields: [fleetId], references: [id], onDelete: Cascade)

  createdAt      DateTime           @default(now())
  updatedAt      DateTime           @updatedAt

  @@index([fleetId])
  @@index([mobile])
}

// Vehicle Model for fleet vehicles
enum VehicleOwnership {
  OWNED
  LEASED
}

enum FuelType {
  PETROL
  DIESEL
  CNG
  ELECTRIC
}

enum VehicleStatus {
  ACTIVE
  INACTIVE
}

model Vehicle {
  id                String          @id @default(uuid())

  fleetId           String
  fleet             Fleet           @relation(fields: [fleetId], references: [id], onDelete: Cascade)
  
  // Assignments relation
  assignments       Assignment[]
  // Trips relation
  // trips relation removed



  vehicleNumber     String
  vehicleName       String
  vehicleModel      String
  vehicleColor      String?

  ownership         VehicleOwnership
  fuelType          FuelType

  rcFrontImage      String?
  rcBackImage       String?

  permitImage       String?
  permitExpiry      DateTime?

  fitnessImage      String?
  fitnessExpiry     DateTime?

  insuranceImage    String?
  insuranceExpiry   DateTime?

  status            VehicleStatus   @default(ACTIVE)

  createdAt         DateTime        @default(now())
  updatedAt         DateTime        @updatedAt

  @@unique([vehicleNumber])
  @@index([fleetId])
}

// Driver Model for fleet drivers
enum DriverStatus {
  ACTIVE
  INACTIVE
}

enum KycStatus {
  PENDING
  APPROVED
  REJECTED
}

model Driver {
  id                   String      @id @default(uuid())

  // Relations
  userId               String      @unique
  user                 User        @relation(fields: [userId], references: [id], onDelete: Cascade)

  fleetId              String
  fleet                Fleet       @relation(fields: [fleetId], references: [id], onDelete: Cascade)
  
  // Assignments realtion
  assignments          Assignment[]
  // Trips relation
  // trips relation removed
  // Trip assignments relation
  tripAssignments      TripAssignment[]
  // Attendance relation
  attendance           Attendance[]
  isAvailable Boolean  @default(true)



  // Basic info
  // Basic info
  firstName            String
  lastName             String
  mobile               String
  licenseNumber        String?
  profilePic           String?

  // KYC documents
  licenseFront         String?
  licenseBack          String?

  aadharFront          String?
  aadharBack           String?

  panCardImage         String?
  livePhoto            String?

  bankIdProof          String?

  // Status
  kycStatus            KycStatus   @default(PENDING)
  status               DriverStatus @default(ACTIVE)

  createdAt            DateTime    @default(now())
  updatedAt            DateTime    @updatedAt

  @@index([fleetId])
  @@index([mobile])
}

// Assignment Model for Driver-Vehicle assignment to Fleet
enum AssignmentStatus {
  ACTIVE
  ENDED
  ASSIGNED
  UNASSIGNED
  COMPLETED
  CANCELLED
}

model Assignment {
  id          String            @id @default(uuid())

  // Relations

  fleetId     String
  fleet       Fleet             @relation(fields: [fleetId], references: [id], onDelete: Cascade)

  driverId    String
  driver      Driver            @relation(fields: [driverId], references: [id], onDelete: Cascade)

  vehicleId   String
  vehicle     Vehicle           @relation(fields: [vehicleId], references: [id], onDelete: Cascade)
  
  // Trips relation
  // trips relation removed


  status      AssignmentStatus  @default(ACTIVE)

  startTime   DateTime          @default(now())
  endTime     DateTime?

  createdAt   DateTime          @default(now())
  updatedAt   DateTime          @updatedAt

  @@index([fleetId])
  @@index([driverId])
  @@index([vehicleId])
}

// Legacy Trip Model Removed (Consolidated into Ride)
enum TripStatus {
  CREATED
  BLOCKED // For MMT/Partner holds
  STARTED
  COMPLETED
  CANCELLED
  NO_SHOW
  DRIVER_ASSIGNED // Added for Ride compatibility
  CANCELLED_BY_PARTNER
}

// RideProviderMapping Model for external ride providers
enum ProviderType {
  INTERNAL
  MOJOBOXX
  MMT
}

enum Provider {
  MOJOBOXX
  MMT
}

enum ProviderBookingStatus {
  PENDING
  CONFIRMED
  FAILED
  CANCELLED
}

enum ProviderRideStatus {
  BOOKED
  DRIVER_ASSIGNED
  STARTED
  COMPLETED
  CANCELLED
  FAILED
}

model RideProviderMapping {
  id                String       @id @default(uuid())
  rideId            String       @unique
  providerType      ProviderType
  externalBookingId String
  providerStatus    String
  rawPayload        Json

  ride Ride @relation(fields: [rideId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// Ride Model for external ride details
// Trip Types
enum TripType {
  AIRPORT
  RENTAL
  INTER_CITY
}

// Ride Model (The "True Trip")
model Ride {
  id              String   @id @default(uuid())
  tripType        TripType
  
  // Location Details
  originCity      String
  destinationCity String   @default("Unknown")
  pickupLocation  String?  // Exact address
  pickupLat       Float?
  pickupLng       Float?
  
  dropLocation    String?  // Exact address
  dropLat         Float?
  dropLng         Float?
  
  pickupTime      DateTime @map("tripDate") // Keeping map for legacy compat if needed
  
  distanceKm      Float
  billableKm      Int?
  ratePerKm       Int?
  price           Float?    @map("totalFare") 
  
  vehicleSku      String?

  status          TripStatus @default(CREATED) // Standardizing Enum
  
  startedAt       DateTime?
  completedAt     DateTime?

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt @default(now())
  
  // Provider Fulfillment Fields
  provider             Provider? 
  providerBookingId    String?
  providerStatus       ProviderBookingStatus?
  providerMeta         Json?
  
  // New: Provider Ride Status for Sync
  providerRideStatus   ProviderRideStatus?

  tripAssignments  TripAssignment[]

  providerMapping RideProviderMapping?
}


// TripAssignment Model for assigning trips to drivers
model TripAssignment {
  id          String   @id @default(uuid())

  tripId      String
  driverId    String

  status      AssignmentStatus @default(ASSIGNED)
  
  // Provider Attempt Tracking
  bookingAttempted     Boolean  @default(false)
  bookingFailedReason  String?

  assignedAt  DateTime @default(now())
  unassignedAt DateTime?

  trip        Ride     @relation(fields: [tripId], references: [id])
  driver      Driver   @relation(fields: [driverId], references: [id])

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

// Attendance Model for Driver Daily Check-in
enum AttendanceStatus {
  PENDING   // Driver checked in, waiting for approval
  APPROVED  // Admin approved, ready for trips
  REJECTED  // Admin rejected (e.g. invalid uniform)
  CHECKED_OUT
}

model Attendance {
  id           String           @id @default(uuid())
  
  driverId     String
  driver       Driver           @relation(fields: [driverId], references: [id])
  
  checkInTime  DateTime         @default(now())
  checkOutTime DateTime?
  
  status       AttendanceStatus @default(PENDING)
  
  approvedBy   String?          // Admin User ID
  adminRemarks String?
  
  checkInLat   Float?
  checkInLng   Float?
  
  selfieUrl    String?
  odometerStart Int?
  odometerEnd   Int?

  createdAt    DateTime         @default(now())
  updatedAt    DateTime         @updatedAt

  @@index([driverId])
  @@index([status])
  @@index([createdAt])
}

