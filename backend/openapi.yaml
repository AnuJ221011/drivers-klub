openapi: 3.0.0
info:
  title: Driver's Klub Backend API
  description: |
    # Driver's Klub Backend API (Master Canonical Reference)
    
    **Version 1.0.0 - Production**
    
    This specification represents the **Single Source of Truth** for the Driver's Klub platform. It combines strict schema definitions, business logic documentation, and comprehensive endpoint coverage.
    
    ## üîç System Overview & Business Logic
    
    ### 1. Trip Intelligence
    *   **Booking Window**: A strict "T-1" rule applies. Trips must be booked at least **1 day in advance**.
    *   **Operational Hours**: Trips cannot start between 12:00 AM and 04:00 AM (`PREBOOK_MIN_HOUR = 4`).
    *   **Allowed Origins**: Pickups are restricted to `DELHI`, `NOIDA`, `GURGAON`, `FARIDABAD`, `GHAZIABAD`.
    *   **Vehicle Policy**: Currently exclusive to `TATA_TIGOR_EV` to meet green fleet targets.
    
    ### 2. Pricing Engine
    *   **Base Rate**: ‚Çπ25.00 per km.
    *   **Minimum Fare**: Minimum billable distance is 5 km.
    *   **Multipliers**:
        *   `AIRPORT`: 1.0x (Standard)
        *   `RENTAL`: 1.1x (Premium Hold)
        *   `INTER_CITY`: 1.2x (Outstation Allowance)
    
    ### 3. Provider Orchestration
    *   The system acts as a meta-layer over external providers (**MojoBoxx**, **MMT**).
    *   **Sync**: Trip status is synced every 60s via background jobs, but can be force-synced via `/providers/{id}/sync`.
    *   **Dispatch**: If internal fleet is unavailable, the `DispatchEngine` routes bookings to external providers automatically.
    
    ### 4. Safety & Ops
    *   **Break-Glass**: Endpoints under `/ops` override all business rules to resolve deadlocks (e.g., driver phone dead, car breakdown).
    *   **Zombie Trips**: Use `/ops/trips/stuck` to find trips stuck in `STARTED` state for > 24 hours.

  version: 1.0.0
  contact:
    name: Driver's Klub Engineering

servers:
  - url: http://localhost:5000
    description: Production API

components:
  securitySchemes:
    bearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT

  schemas:
    # --- COMMON ---
    ApiResponse:
      type: object
      required: 
        - message
      properties:
        message: 
          type: string
          example: "Operation completed successfully"

    # --- ENUMS ---
    UserRole:
      type: string
      enum: 
        - SUPER_ADMIN
        - OPERATIONS
        - MANAGER
        - DRIVER
      description: "RBAC Role. SUPER_ADMIN has root access."
    TripType: 
      type: string
      enum: 
        - AIRPORT
        - RENTAL
        - INTER_CITY
      description: "Determines pricing logic."
    FuelType: 
      type: string
      enum: 
        - PETROL
        - DIESEL
        - CNG
        - ELECTRIC
    VehicleOwnership: 
      type: string
      enum: 
        - OWNED
        - LEASED
    VehicleStatus: 
      type: string
      enum: 
        - ACTIVE
        - INACTIVE
        - MAINTENANCE
    
    # --- CORE ENTITIES ---
    User:
      type: object
      properties:
        id: 
          type: string
          format: uuid
          example: "550e8400-e29b-41d4-a716-446655440000"
        name: 
          type: string
          example: "Aditya Sharma"
        phone: 
          type: string
          example: "+919876543210"
        role: 
          $ref: '#/components/schemas/UserRole'
        isActive: 
          type: boolean
    
    Driver:
      type: object
      properties:
        id: 
          type: string
          format: uuid
        firstName: 
          type: string
          example: "Rajesh"
        lastName: 
          type: string
          example: "Kumar"
        mobile: 
          type: string
          example: "+919999988888"
        licenseNumber: 
          type: string
          example: "DL1420110012345"
        isAvailable: 
          type: boolean
        fleetId: 
          type: string
          format: uuid

    Fleet:
      type: object
      properties:
        id: 
          type: string
          format: uuid
        name: 
          type: string
          example: "Delhi Darshan Travels"
        city: 
          type: string
          example: "Delhi"
        mobile: 
          type: string
          example: "+911122334455"

    FleetManager:
      type: object
      properties:
        id: 
          type: string
          format: uuid
        name: 
          type: string
        mobile: 
          type: string
        fleetId: 
          type: string
          format: uuid

    Vehicle:
      type: object
      properties:
        id: 
          type: string
          format: uuid
        vehicleNumber: 
          type: string
          example: "DL01CAB1234"
        model: 
          type: string
          example: "Tata Tigor EV"
        status: 
          $ref: '#/components/schemas/VehicleStatus'

    Trip:
      type: object
      properties:
        id: 
          type: string
          format: uuid
        tripType: 
          $ref: '#/components/schemas/TripType'
        originCity: 
          type: string
          example: "GURGAON"
        destinationCity: 
          type: string
          example: "AIRPORT T3"
        tripDate: 
          type: string
          format: date-time
        status: 
          type: string
          example: "CREATED"
        price: 
          type: number
          example: 850.50
        provider: 
          type: string
          example: "MOJOBOXX"

    Assignment:
      type: object
      properties:
        id: 
          type: string
          format: uuid
        driverId: 
          type: string
          format: uuid
        vehicleId: 
          type: string
          format: uuid
        startTime: 
          type: string
          format: date-time
        status: 
          type: string
          example: "ACTIVE"

security:
  - bearerAuth: []

paths:
  # ================= 1Ô∏è‚É£ AUTHENTICATION & SESSION =================
  /auth/send-otp:
    post:
      summary: Send Login OTP
      description: |
        Triggers an OTP SMS. 
        **Logic**: Uses Exotel API. Limits to 3 OTPs/10min.
        **Privacy**: Returns strict success even if phone not registered (prevent enum).
      tags: [Auth]
      security: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [phone]
              properties:
                phone: 
                  type: string
                  example: "+919999999999"
                role: 
                  type: string
                  example: "DRIVER"
      responses:
        200:
          description: OTP Sent
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ApiResponse'

  /auth/verify-otp:
    post:
      summary: Verify OTP
      description: "Exchange OTP for JWT Tokens (Access + Refresh)."
      tags: [Auth]
      security: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [phone, otp]
              properties:
                phone: 
                  type: string
                otp: 
                  type: string
      responses:
        200: 
          description: Tokens Issued
          content:
            application/json:
              schema:
                type: object
                properties:
                  accessToken: 
                    type: string
                  refreshToken: 
                    type: string
                  user: 
                    $ref: '#/components/schemas/User'

  /auth/resend-otp:
    post:
      summary: Resend OTP
      description: "Re-trigger last OTP. Must wait 60 seconds between calls."
      tags: [Auth]
      security: []
      requestBody:
        content:
          application/json:
            schema:
              type: object
              properties:
                phone: 
                  type: string
      responses: 
        200:
          description: OTP Resent
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ApiResponse'

  /auth/refresh-token:
    post:
      summary: Refresh Access Token
      description: "Use long-lived Refresh Token to get short-lived Access Token."
      tags: [Auth]
      security: []
      requestBody:
        content:
          application/json:
            schema:
              type: object
              properties:
                refreshToken: 
                  type: string
      responses: 
        200:
          description: Token Refreshed
          content:
            application/json:
              schema:
                type: object
                properties:
                  accessToken: 
                    type: string

  /auth/me:
    get:
      summary: Get Current Session User
      description: "Who am I? Resolve JWT to User Profile."
      tags: [Auth]
      responses:
        200:
          description: Success
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/User'

  # ================= 2Ô∏è‚É£ USERS & RBAC =================
  /users:
    post:
      summary: Create New User
      description: "**Admin Only**. Create back-office staff or fleet managers."
      tags: [Users]
      requestBody:
        content:
          application/json:
            schema:
              type: object
              required: [name, phone]
              properties:
                name: 
                  type: string
                phone: 
                  type: string
                role: 
                  type: string
      responses:
        201:
          description: User Created
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/User'
    get:
      summary: List All Users
      tags: [Users]
      responses:
        200:
          description: Success
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/User'

  /users/{id}:
    get:
      summary: Get User Detail
      tags: [Users]
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
            format: uuid
          example: "550e8400-e29b-41d4-a716-446655440000"
      responses:
        200:
          description: Success
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/User'

  /users/{id}/status:
    patch:
      summary: Toggle User Status
      description: "Soft delete/ban functionality. Sets `isActive=false`."
      tags: [Users]
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
            format: uuid
          example: "550e8400-e29b-41d4-a716-446655440000"
      requestBody:
        content:
          application/json:
            schema:
              type: object
              properties:
                isActive: 
                  type: boolean
      responses:
        200:
          description: Status Updated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/User'

  # ================= 3Ô∏è‚É£ DRIVERS =================
  /drivers:
    post:
      summary: Onboard Driver
      description: "Register a driver. Requires validated KYC docs (Aadhar/License)."
      tags: [Drivers]
      requestBody:
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/Driver'
      responses:
        201:
          description: Driver Created
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Driver'
    get:
      summary: List All Drivers
      tags: [Drivers]
      responses:
        200:
          description: Success
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/Driver'

  /drivers/{id}:
    get:
      summary: Get Driver Profile
      tags: [Drivers]
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
            format: uuid
          example: "550e8400-e29b-41d4-a716-446655440000"
      responses:
        200:
          description: Success
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Driver'
    patch:
      summary: Update Driver Profile
      tags: [Drivers]
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
            format: uuid
          example: "550e8400-e29b-41d4-a716-446655440000"
      requestBody:
        content:
          application/json:
            schema:
              type: object
              properties:
                firstName: 
                  type: string
                licenseNumber: 
                  type: string
      responses:
        200:
          description: Updated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Driver'

  /drivers/{id}/availability:
    patch:
      summary: Set Driver Availability
      description: "Driver toggle: Online/Offline. offline drivers are ignored by Dispatch."
      tags: [Drivers]
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
            format: uuid
          example: "550e8400-e29b-41d4-a716-446655440000"
      requestBody:
        content:
          application/json:
            schema:
              type: object
              properties:
                isAvailable: 
                  type: boolean
      responses:
        200:
          description: Updated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Driver'

  /drivers/{id}/assignments:
    get:
      summary: Driver Assignment Logs
      tags: [Drivers]
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
            format: uuid
          example: "550e8400-e29b-41d4-a716-446655440000"
      responses:
        200:
          description: Success
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/Assignment'

  /drivers/{id}/trips:
    get:
      summary: Driver Trip History
      tags: [Drivers]
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
            format: uuid
          example: "550e8400-e29b-41d4-a716-446655440000"
      responses:
        200:
          description: Success
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/Trip'

  # ================= 4Ô∏è‚É£ FLEETS & FLEET MANAGERS =================
  /fleets:
    post:
      summary: Create Fleet Organization
      tags: [Fleets]
      requestBody:
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/Fleet'
      responses:
        201:
          description: Created
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Fleet'
    get:
      summary: List Fleets
      tags: [Fleets]
      responses:
        200:
          description: Success
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/Fleet'

  /fleets/{id}:
    get:
      summary: Get Fleet Details
      tags: [Fleets]
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
            format: uuid
          example: "550e8400-e29b-41d4-a716-446655440000"
      responses:
        200:
          description: Success
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Fleet'

  /fleets/{id}/managers:
    post:
      summary: Add Manager to Fleet
      tags: [Fleets]
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
            format: uuid
          example: "550e8400-e29b-41d4-a716-446655440000"
      requestBody:
        content:
          application/json:
            schema:
              type: object
              required: [name, mobile]
              properties:
                name: 
                  type: string
                mobile: 
                  type: string
      responses:
        201:
          description: Manager Added
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/FleetManager'

  /fleets/{id}/drivers:
    get:
      summary: List Fleet Drivers
      tags: [Fleets]
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
            format: uuid
          example: "550e8400-e29b-41d4-a716-446655440000"
      responses:
        200:
          description: Success
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/Driver'

  /fleets/{id}/vehicles:
    get:
      summary: List Fleet Vehicles
      tags: [Fleets]
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
            format: uuid
          example: "550e8400-e29b-41d4-a716-446655440000"
      responses:
        200:
          description: Success
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/Vehicle'

  # ================= 5Ô∏è‚É£ VEHICLES =================
  /vehicles:
    post:
      summary: Add New Vehicle
      tags: [Vehicles]
      requestBody:
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/Vehicle'
      responses:
        201:
          description: Created
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Vehicle'
    get:
      summary: List All Vehicles
      tags: [Vehicles]
      responses:
        200:
          description: Success
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/Vehicle'

  /vehicles/{id}:
    get:
      summary: Get Vehicle Details
      tags: [Vehicles]
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
            format: uuid
          example: "550e8400-e29b-41d4-a716-446655440000"
      responses:
        200:
          description: Success
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Vehicle'
    patch:
      summary: Update Vehicle Details
      tags: [Vehicles]
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
            format: uuid
          example: "550e8400-e29b-41d4-a716-446655440000"
      responses:
        200:
          description: Updated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Vehicle'

  /vehicles/{id}/status:
    patch:
      summary: Set Vehicle Status
      tags: [Vehicles]
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
            format: uuid
          example: "550e8400-e29b-41d4-a716-446655440000"
      requestBody:
        content:
          application/json:
            schema:
              type: object
              properties:
                status: 
                  type: string
      responses:
        200:
          description: Status Updated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Vehicle'

  /vehicles/{id}/assignments:
    get:
      summary: Vehicle Usage History
      tags: [Vehicles]
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
            format: uuid
          example: "550e8400-e29b-41d4-a716-446655440000"
      responses:
        200:
          description: Success
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/Assignment'

  # ================= 6Ô∏è‚É£ TRIPS (CORE DOMAIN) =================
  /trips:
    post:
      summary: Create / Book Trip
      description: |
        **Core Logic**: 
        1. Checks `TripRules`: Next-Day only.
        2. Checks `PricingConfig`: Calculates base + multiplier.
        3. Creates Trip in `CREATED` status.
      tags: [Trips]
      requestBody:
        content:
          application/json:
            schema:
              type: object
              required: [tripType, originCity, tripDate]
              properties:
                tripType: 
                  $ref: '#/components/schemas/TripType'
                originCity: 
                  type: string
                tripDate: 
                  type: string
                  format: date-time
                distanceKm: 
                  type: number
      responses:
        201:
          description: Created
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Trip'
    get:
      summary: List Trips (Paginated)
      tags: [Trips]
      responses:
        200:
          description: Success
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/Trip'

  /trips/{id}:
    get:
      summary: Get Trip Details
      tags: [Trips]
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
            format: uuid
          example: "550e8400-e29b-41d4-a716-446655440000"
      responses:
        200:
          description: Success
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Trip'

  /trips/{id}/assignments:
    get:
      summary: Get Driver Assignment
      tags: [Trips]
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
            format: uuid
          example: "550e8400-e29b-41d4-a716-446655440000"
      responses:
        200:
          description: Success
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/Assignment'

  /trips/{id}/cancel:
    post:
      summary: Client Cancel Trip
      description: "Cancels trip. If within 4 hours, cancellation fee applies."
      tags: [Trips]
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
            format: uuid
          example: "550e8400-e29b-41d4-a716-446655440000"
      responses:
        200:
          description: Cancelled
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ApiResponse'

  /trips/{id}/start:
    post:
      summary: Start Trip (Driver)
      description: "State transition: DRIVER_ASSIGNED -> STARTED."
      tags: [Trips]
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
            format: uuid
          example: "550e8400-e29b-41d4-a716-446655440000"
      responses:
        200:
          description: Started
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Trip'

  /trips/{id}/complete:
    post:
      summary: Complete Trip (Driver)
      description: "State transition: STARTED -> COMPLETED. Triggers invoice generation."
      tags: [Trips]
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
            format: uuid
          example: "550e8400-e29b-41d4-a716-446655440000"
      responses:
        200:
          description: Completed
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Trip'

  /trips/{id}/update-time:
    patch:
      summary: Reschedule Trip
      tags: [Trips]
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
            format: uuid
          example: "550e8400-e29b-41d4-a716-446655440000"
      requestBody:
        content:
          application/json:
            schema:
              type: object
              required: [newDate]
              properties:
                newDate: 
                  type: string
                  format: date-time
      responses:
        200:
          description: Time Updated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Trip'

  /trips/{id}/update-route:
    patch:
      summary: Modify Route / Destination
      tags: [Trips]
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
            format: uuid
          example: "550e8400-e29b-41d4-a716-446655440000"
      requestBody:
        content:
          application/json:
            schema:
              type: object
              properties:
                destination: 
                  type: string
                distanceKm: 
                  type: number
      responses:
        200:
          description: Route Updated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Trip'

  /trips/{id}/provider:
    get:
      summary: Get Fulfillment Provider
      tags: [Trips]
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
            format: uuid
          example: "550e8400-e29b-41d4-a716-446655440000"
      responses:
        200:
          description: Success
          content:
            application/json:
              schema:
                type: object
                properties:
                  providerName: 
                    type: string
                  bookingId: 
                    type: string

  /trips/{id}/status-history:
    get:
      summary: Audit Log (Status History)
      tags: [Trips]
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
            format: uuid
          example: "550e8400-e29b-41d4-a716-446655440000"
      responses:
        200:
          description: Success
          content:
            application/json:
              schema:
                type: array
                items:
                  type: object
                  properties:
                    status: 
                      type: string
                    timestamp: 
                      type: string

  /trips/{id}/confirm:
    post:
      summary: Manual Confirm (Ops)
      description: "Force transition `CREATED -> CONFIRMED`. Bypasses auto-dispatch checks."
      tags: [Trips]
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
            format: uuid
          example: "550e8400-e29b-41d4-a716-446655440000"
      responses:
        200:
          description: Confirmed
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Trip'

  # ================= 7Ô∏è‚É£ MANUAL DISPATCH / ASSIGNMENT =================
  /trips/{id}/assign:
    post:
      summary: Manual Dispatch (Assign Driver)
      description: "Assigns driver and triggers provider invite."
      tags: [Dispatch]
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
            format: uuid
          example: "550e8400-e29b-41d4-a716-446655440000"
      requestBody:
        content:
          application/json:
            schema:
              type: object
              required: [driverId]
              properties:
                driverId: 
                  type: string
                  format: uuid
      responses:
        200:
          description: Assigned
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Assignment'

  /trips/{id}/unassign:
    post:
      summary: Remove Driver
      tags: [Dispatch]
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
            format: uuid
          example: "550e8400-e29b-41d4-a716-446655440000"
      responses:
        200:
          description: Unassigned
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ApiResponse'

  /trips/{id}/reassign:
    post:
      summary: Reassign (Swap) Driver
      tags: [Dispatch]
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
            format: uuid
          example: "550e8400-e29b-41d4-a716-446655440000"
      requestBody:
        content:
          application/json:
            schema:
              type: object
              required: [driverId]
              properties:
                driverId: 
                  type: string
                  format: uuid
      responses:
        200:
          description: Reassigned
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Assignment'

  /assignments:
    get:
      summary: View Roster
      tags: [Dispatch]
      responses:
        200:
          description: Success
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/Assignment'

  /assignments/{id}:
    get:
      summary: Get Roster Entry
      tags: [Dispatch]
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
            format: uuid
          example: "550e8400-e29b-41d4-a716-446655440000"
      responses:
        200:
          description: Success
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Assignment'

  /assignments/{id}/history:
  /assignments/trip/{tripId}:
    get:
      summary: Get Trip Assignments (Driver + Vehicle)
      tags: [Assignments]
      parameters:
        - name: tripId
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        200:
          description: Success
          content:
            application/json:
              schema:
                type: array
                items:
                  type: object
                  properties:
                    id:
                      type: string
                      format: uuid
                    tripId:
                      type: string
                      format: uuid
                    driverId:
                      type: string
                      format: uuid
                    vehicleId:
                      type: string
                      format: uuid
                      nullable: true
                    status:
                      type: string
                    startTime:
                      type: string
                      format: date-time
                    endTime:
                      type: string
                      format: date-time
                      nullable: true
                    createdAt:
                      type: string
                      format: date-time
                    updatedAt:
                      type: string
                      format: date-time
    get:
      summary: Assignment Change Logs
      tags: [Dispatch]
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
            format: uuid
          example: "550e8400-e29b-41d4-a716-446655440000"
      responses:
        200:
          description: Success
          content:
            application/json:
              schema:
                type: array
                items:
                  type: object

  # ================= 8Ô∏è‚É£ PROVIDER (MMT / MOJOBOXX) OPS =================
  /providers/{tripId}/book:
    post:
      summary: Force Book Provider API
      description: "Direct API Call: `MojoBoxx.createBooking()`. Bypasses internal cache."
      tags: [Providers]
      parameters:
        - name: tripId
          in: path
          required: true
          schema:
            type: string
            format: uuid
          example: "550e8400-e29b-41d4-a716-446655440000"
      responses:
        200:
          description: Booked
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ApiResponse'

  /providers/{tripId}/cancel:
    post:
      summary: Force Cancel Provider API
      tags: [Providers]
      parameters:
        - name: tripId
          in: path
          required: true
          schema:
            type: string
            format: uuid
          example: "550e8400-e29b-41d4-a716-446655440000"
      responses:
        200:
          description: Cancelled
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ApiResponse'

  /providers/{tripId}/retry:
    post:
      summary: Retry Failed Booking
      tags: [Providers]
      parameters:
        - name: tripId
          in: path
          required: true
          schema:
            type: string
            format: uuid
          example: "550e8400-e29b-41d4-a716-446655440000"
      responses:
        200:
          description: Retrying
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ApiResponse'

  /providers/{tripId}/status:
    get:
      summary: Check External Status
      tags: [Providers]
      parameters:
        - name: tripId
          in: path
          required: true
          schema:
            type: string
            format: uuid
          example: "550e8400-e29b-41d4-a716-446655440000"
      responses:
        200:
          description: Success
          content:
            application/json:
              schema:
                type: object
                properties:
                  status: 
                    type: string

  /providers/{tripId}/raw-response:
    get:
      summary: Get Raw Provider Response
      tags: [Providers]
      parameters:
        - name: tripId
          in: path
          required: true
          schema:
            type: string
            format: uuid
          example: "550e8400-e29b-41d4-a716-446655440000"
      responses:
        200:
          description: Success
          content:
            application/json:
              schema:
                type: object

  /providers/{tripId}/sync:
    get:
      summary: Sync Trip State
      description: "Pull latest status from Provider and update DB."
      tags: [Providers]
      parameters:
        - name: tripId
          in: path
          required: true
          schema:
            type: string
            format: uuid
          example: "550e8400-e29b-41d4-a716-446655440000"
      responses:
        200:
          description: Synced
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ApiResponse'

  /providers/{tripId}/force-complete:
    post:
      summary: Force Complete Trip (Provider)
      description: "Use when provider system is down but trip actually finished."
      tags: [Providers]
      parameters:
        - name: tripId
          in: path
          required: true
          schema:
            type: string
            format: uuid
          example: "550e8400-e29b-41d4-a716-446655440000"
      responses:
        200:
          description: Forced Completion
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Trip'

  # ================= 9Ô∏è‚É£ OPS / ADMIN SAFETY =================
  /ops/trips/{id}/override-status:
    post:
      summary: Emergency Status Override
      description: "‚ö†Ô∏è DANGER: Force DB status change. No side-effects triggered."
      tags: [Ops]
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
            format: uuid
          example: "550e8400-e29b-41d4-a716-446655440000"
      requestBody:
        content:
          application/json:
            schema:
              type: object
              required: [status]
              properties:
                status: 
                  type: string
      responses:
        200:
          description: Overridden
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Trip'

  /ops/trips/{id}/override-driver:
    post:
      summary: Emergency Driver Override
      tags: [Ops]
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
            format: uuid
          example: "550e8400-e29b-41d4-a716-446655440000"
      requestBody:
        content:
          application/json:
            schema:
              type: object
              required: [driverId]
              properties:
                driverId: 
                  type: string
                  format: uuid
      responses:
        200:
          description: Overridden
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Trip'

  /ops/trips/failed:
    get:
      summary: List Failed/Error Trips
      tags: [Ops]
      responses:
        200:
          description: Success
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/Trip'

  /ops/trips/stuck:
    get:
      summary: List Stuck Trips
      tags: [Ops]
      responses:
        200:
          description: Success
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/Trip'

  # ================= üîü SYSTEM / INTERNAL =================
  /health:
    get:
      summary: System Health Check
      tags: [System]
      responses:
        200:
          description: OK
          content:
            application/json; charset=utf-8:
              schema:
                type: object
                properties:
                  status: 
                    type: string
                    example: "ok"
                  service:
                    type: string
                    example: "drivers-klub-backend"
                  timestamp:
                    type: string
                    example: "2023-10-25T12:00:00Z"


